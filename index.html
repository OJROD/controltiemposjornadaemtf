<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Control de Tiempos Jornada Conductores EMT Fuenlabrada</title>
    <style>
        /* Estilos generales */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f6f8;
            color: #333;
        }
        h1, h2 {
            text-align: center;
            font-weight: 300;
            color: #2c3e50;
        }
        h1 {
            margin-top: 30px;
        }
        h2 {
            margin-top: 50px;
        }
        /* Estilos del formulario */
        form {
            max-width: 900px;
            margin: 30px auto;
            padding: 25px;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        form div {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        form div label {
            flex: 1 0 200px;
            margin-right: 10px;
            font-weight: bold;
            align-self: center;
        }
        form div input {
            flex: 2 0 300px;
            padding: 8px;
            border: 1px solid #ccd0d5;
            border-radius: 5px;
        }
        form div button {
            margin-top: 10px;
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        /* Estilos de los botones */
        .btn-primary {
            background-color: #3498db;
            color: #fff;
        }
        .btn-primary:hover {
            background-color: #2980b9;
        }
        .btn-secondary {
            background-color: #95a5a6;
            color: #fff;
        }
        .btn-secondary:hover {
            background-color: #7f8c8d;
        }
        .btn-success {
            background-color: #27ae60;
            color: #fff;
        }
        .btn-success:hover {
            background-color: #1e8449;
        }
        .btn-warning {
            background-color: #f1c40f;
            color: #fff;
        }
        .btn-warning:hover {
            background-color: #d4ac0d;
        }
        .btn-danger {
            background-color: #e74c3c;
            color: #fff;
        }
        .btn-danger:hover {
            background-color: #c0392b;
        }
        /* Estilos de las tablas */
        .tabla-registros {
            width: 95%;
            border-collapse: collapse;
            margin: 30px auto;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        .tabla-registros th, .tabla-registros td {
            border: 1px solid #e1e4e8;
            padding: 10px;
            text-align: center;
            font-size: 14px;
        }
        .tabla-registros th {
            background-color: #2c3e50;
            color: #ecf0f1;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        .dia-libre {
            background-color: #d6eaf8 !important;
        }
        .exceso-jornada {
            background-color: #fcf3cf !important;
        }
        /* Estilos de los botones de acción */
        .botones-accion {
            text-align: center;
            margin: 20px 0;
        }
        .botones-accion button {
            margin: 5px;
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        /* Estilos de resumen anual */
        .resumen-anual {
            width: 90%;
            margin: 30px auto;
            padding: 20px;
            background-color: #ecf0f1;
            border-radius: 10px;
            text-align: center;
        }
        .resumen-anual p {
            font-size: 16px;
            margin: 10px 0;
        }
        .resumen-anual strong {
            color: #2c3e50;
        }
        /* Responsive Design */
        @media (max-width: 768px) {
            form div {
                flex-direction: column;
            }
            form div label, form div input {
                flex: 1 0 100%;
            }
            form div label {
                margin-bottom: 5px;
            }
            .tabla-registros {
                font-size: 12px;
            }
            .tabla-registros th, .tabla-registros td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>

    <h1>Control de Tiempos Jornada Conductores</h1>

    <form id="formulario">
        <!-- Campos del formulario -->
        <div>
            <label for="fecha">Fecha:</label>
            <input type="date" id="fecha" required>
        </div>
        <div>
            <label for="numeroConductor">Número de Conductor:</label>
            <input type="number" id="numeroConductor" required>
        </div>
        <div>
            <label for="linea">Línea:</label>
            <input type="text" id="linea" required>
        </div>
        <div>
            <label for="numeroTurno">Número de Turno:</label>
            <input type="number" id="numeroTurno" required>
        </div>
        <div>
            <label for="horaInicioHoja">Hora de Inicio (Hoja de Servicios):</label>
            <input type="time" id="horaInicioHoja" required>
        </div>
        <div>
            <label for="horaFinHoja">Hora de Fin (Hoja de Servicios):</label>
            <input type="time" id="horaFinHoja" required>
        </div>
        <div>
            <label for="login">Login (Máquina Expendedora):</label>
            <input type="time" id="login" required>
            <button type="button" class="btn-secondary" onclick="autoCompletarHora('login')">Añadir Hora Actual</button>
        </div>
        <div>
            <label for="logout">Logout (Máquina Expendedora):</label>
            <input type="time" id="logout" required>
            <button type="button" class="btn-secondary" onclick="autoCompletarHora('logout')">Añadir Hora Actual</button>
        </div>
        <div>
            <label for="numeroAutobus">Número de Autobús:</label>
            <input type="text" id="numeroAutobus" required>
        </div>
        <div>
            <label for="totalViajeros">Número Total de Viajeros:</label>
            <input type="number" id="totalViajeros" required>
        </div>
        <div>
            <label for="ventaBilletes">Venta Total de Billetes:</label>
            <input type="number" id="ventaBilletes" required>
        </div>
        <div>
            <label for="observaciones">Observaciones:</label>
            <input type="text" id="observaciones">
        </div>
        <!-- Botones del formulario -->
        <div class="botones-accion">
            <button type="button" class="btn-success" onclick="guardarRegistro()">Guardar Registro</button>
            <button type="reset" class="btn-secondary">Limpiar Formulario</button>
            <button type="button" class="btn-warning" onclick="diaLibre()">Día Libre</button>
        </div>
    </form>

    <!-- Botones de exportar e importar datos -->
    <div class="botones-accion">
        <button type="button" class="btn-primary" onclick="exportarDatos()">Exportar Datos (JSON)</button>
        <button type="button" class="btn-primary" onclick="document.getElementById('inputImportar').click()">Importar Datos (JSON)</button>
        <input type="file" id="inputImportar" style="display: none;" onchange="importarDatos(event)">
        <button type="button" class="btn-danger" onclick="eliminarRegistros()">Eliminar Registros</button>
    </div>

    <!-- Contenedor para las tablas de registros -->
    <div id="contenedorTablas"></div>

    <script>
        // Variables globales
        let registros = [];

        // Cargar registros desde localStorage al iniciar
        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('registros')) {
                registros = JSON.parse(localStorage.getItem('registros'));
                actualizarTablas();
            }
        });

        // Función para autocompletar la hora actual
        function autoCompletarHora(campo) {
            const ahora = new Date();
            const horas = String(ahora.getHours()).padStart(2, '0');
            const minutos = String(ahora.getMinutes()).padStart(2, '0');
            const horaActual = `${horas}:${minutos}`;
            document.getElementById(campo).value = horaActual;
        }

        // Función para guardar o actualizar un registro
        function guardarRegistro() {
            // Obtener valores del formulario
            const fecha = document.getElementById('fecha').value;
            const numeroConductor = document.getElementById('numeroConductor').value;
            const linea = document.getElementById('linea').value;
            const numeroTurno = document.getElementById('numeroTurno').value;
            const horaInicioHoja = document.getElementById('horaInicioHoja').value;
            const horaFinHoja = document.getElementById('horaFinHoja').value;
            const login = document.getElementById('login').value;
            const logout = document.getElementById('logout').value;
            const numeroAutobus = document.getElementById('numeroAutobus').value;
            const totalViajeros = document.getElementById('totalViajeros').value;
            const ventaBilletes = document.getElementById('ventaBilletes').value;
            const observaciones = document.getElementById('observaciones').value;

            // Validar campos obligatorios
            if (!fecha || !numeroConductor || !linea || !numeroTurno || !horaInicioHoja || !horaFinHoja || !login || !logout || !numeroAutobus || !totalViajeros || !ventaBilletes) {
                alert('Por favor, completa todos los campos obligatorios.');
                return;
            }

            // Calcular tiempos y liquidación
            const tiempoTotalHoja = calcularDiferenciaHoras(horaInicioHoja, horaFinHoja);
            const tiempoOperativo = calcularDiferenciaHoras(login, logout);
            const excesoJornada = calcularExcesoJornada(horaFinHoja, logout);
            const liquidacionTotal = (ventaBilletes * 1.30).toFixed(2);

            // Crear registro
            const registro = {
                fecha,
                numeroConductor,
                linea,
                numeroTurno,
                horaInicioHoja,
                horaFinHoja,
                login,
                logout,
                numeroAutobus,
                totalViajeros,
                ventaBilletes,
                observaciones,
                tiempoTotalHoja,
                tiempoOperativo,
                excesoJornada,
                liquidacionTotal,
                diaLibre: false
            };

            // Verificar si el registro ya existe
            const indice = registros.findIndex(r => r.fecha === fecha && r.numeroConductor === numeroConductor);

            if (indice >= 0) {
                registros[indice] = registro;
                alert('Registro actualizado correctamente.');
            } else {
                registros.push(registro);
                alert('Registro guardado correctamente.');
            }

            // Guardar en localStorage y actualizar tablas
            localStorage.setItem('registros', JSON.stringify(registros));
            actualizarTablas();
            document.getElementById('formulario').reset();
        }

        // Función para asignar día libre
        function diaLibre() {
            const fecha = document.getElementById('fecha').value;
            const numeroConductor = document.getElementById('numeroConductor').value;

            if (!fecha || !numeroConductor) {
                alert('Por favor, ingresa la fecha y el número de conductor.');
                return;
            }

            const registro = {
                fecha,
                numeroConductor,
                linea: 'DÍA LIBRE',
                numeroTurno: '0',
                horaInicioHoja: '00:00',
                horaFinHoja: '00:00',
                login: '00:00',
                logout: '00:00',
                numeroAutobus: '0',
                totalViajeros: '0',
                ventaBilletes: '0',
                observaciones: 'DÍA LIBRE',
                tiempoTotalHoja: '00:00',
                tiempoOperativo: '00:00',
                excesoJornada: '00:00',
                liquidacionTotal: '0.00',
                diaLibre: true
            };

            // Verificar si el registro ya existe
            const indice = registros.findIndex(r => r.fecha === fecha && r.numeroConductor === numeroConductor);

            if (indice >= 0) {
                registros[indice] = registro;
                alert('Día libre actualizado correctamente.');
            } else {
                registros.push(registro);
                alert('Día libre guardado correctamente.');
            }

            localStorage.setItem('registros', JSON.stringify(registros));
            actualizarTablas();
            document.getElementById('formulario').reset();
        }

        // Función para calcular diferencia de horas
        function calcularDiferenciaHoras(inicio, fin) {
            const [hInicio, mInicio] = inicio.split(':').map(Number);
            const [hFin, mFin] = fin.split(':').map(Number);

            let minutosInicio = hInicio * 60 + mInicio;
            let minutosFin = hFin * 60 + mFin;

            if (minutosFin < minutosInicio) {
                minutosFin += 24 * 60; // Cruce de medianoche
            }

            const diferencia = minutosFin - minutosInicio;
            return minutosAHoraMinutos(diferencia);
        }

        // Función para calcular exceso de jornada
        function calcularExcesoJornada(horaFinHoja, logout) {
            const [hFinHoja, mFinHoja] = horaFinHoja.split(':').map(Number);
            const [hLogout, mLogout] = logout.split(':').map(Number);

            let minutosFinHoja = hFinHoja * 60 + mFinHoja;
            let minutosLogout = hLogout * 60 + mLogout;

            if (minutosLogout < minutosFinHoja) {
                minutosLogout += 24 * 60; // Cruce de medianoche
            }

            let diferencia = minutosLogout - minutosFinHoja;

            if (diferencia > 0 && diferencia <= 720) {
                return minutosAHoraMinutos(diferencia);
            } else {
                return '00:00';
            }
        }

        // Función para convertir minutos a formato HH:MM
        function minutosAHoraMinutos(minutos) {
            const horas = Math.floor(minutos / 60);
            const minutosRestantes = minutos % 60;
            return `${String(horas).padStart(2, '0')}:${String(minutosRestantes).padStart(2, '0')}`;
        }

        // Función para sumar múltiples tiempos
        function sumarTiempos(tiempos) {
            let totalMinutos = 0;
            tiempos.forEach(tiempo => {
                const [horas, minutos] = tiempo.split(':').map(Number);
                totalMinutos += horas * 60 + minutos;
            });
            return minutosAHoraMinutos(totalMinutos);
        }

        // Función para actualizar las tablas
        function actualizarTablas() {
            const contenedor = document.getElementById('contenedorTablas');
            contenedor.innerHTML = '';

            // Agrupar registros por año y mes
            const registrosOrdenados = registros.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            const agrupados = {};

            registrosOrdenados.forEach(registro => {
                const fecha = new Date(registro.fecha);
                const año = fecha.getFullYear();
                const mes = fecha.getMonth() + 1;

                if (!agrupados[año]) agrupados[año] = {};
                if (!agrupados[año][mes]) agrupados[año][mes] = [];
                agrupados[año][mes].push(registro);
            });

            // Ordenar años y meses
            const años = Object.keys(agrupados).sort((a, b) => b - a);

            años.forEach(año => {
                const meses = Object.keys(agrupados[año]).sort((a, b) => b - a);

                meses.forEach(mes => {
                    const registrosMes = agrupados[año][mes];

                    // Crear tabla
                    const tabla = document.createElement('table');
                    tabla.classList.add('tabla-registros');

                    // Crear encabezados
                    const thead = document.createElement('thead');
                    const filaEncabezado = document.createElement('tr');
                    const encabezados = [
                        'Fecha',
                        'Nº Conductor',
                        'Línea',
                        'Nº Turno',
                        'Inicio Hoja',
                        'Fin Hoja',
                        'Login',
                        'Logout',
                        'Nº Autobús',
                        'Total Viajeros',
                        'Venta Billetes',
                        'Observaciones',
                        'Tiempo Total Hoja',
                        'Tiempo Operativo',
                        'Exceso Jornada',
                        'Liquidación Total (€)'
                    ];
                    encabezados.forEach(texto => {
                        const th = document.createElement('th');
                        th.textContent = texto;
                        filaEncabezado.appendChild(th);
                    });
                    thead.appendChild(filaEncabezado);
                    tabla.appendChild(thead);

                    // Crear cuerpo de la tabla
                    const tbody = document.createElement('tbody');

                    let totales = {
                        tiempoTotalHoja: [],
                        tiempoOperativo: [],
                        excesoJornada: [],
                        totalViajeros: 0,
                        ventaBilletes: 0,
                        liquidacionTotal: 0
                    };

                    registrosMes.forEach(registro => {
                        const fila = document.createElement('tr');
                        fila.addEventListener('click', () => rellenarFormulario(registro));

                        if (registro.diaLibre) {
                            fila.classList.add('dia-libre');
                        }

                        const valores = [
                            registro.fecha,
                            registro.numeroConductor,
                            registro.linea,
                            registro.numeroTurno,
                            registro.horaInicioHoja,
                            registro.horaFinHoja,
                            registro.login,
                            registro.logout,
                            registro.numeroAutobus,
                            registro.totalViajeros,
                            registro.ventaBilletes,
                            registro.observaciones,
                            registro.tiempoTotalHoja,
                            registro.tiempoOperativo,
                            registro.excesoJornada,
                            registro.liquidacionTotal
                        ];

                        valores.forEach((valor, index) => {
                            const td = document.createElement('td');
                            td.textContent = valor;

                            if (encabezados[index] === 'Exceso Jornada' && valor !== '00:00') {
                                td.classList.add('exceso-jornada');
                            }

                            fila.appendChild(td);
                        });

                        // Acumular totales
                        totales.tiempoTotalHoja.push(registro.tiempoTotalHoja);
                        totales.tiempoOperativo.push(registro.tiempoOperativo);
                        totales.excesoJornada.push(registro.excesoJornada);
                        totales.totalViajeros += parseInt(registro.totalViajeros);
                        totales.ventaBilletes += parseFloat(registro.ventaBilletes);
                        totales.liquidacionTotal += parseFloat(registro.liquidacionTotal);

                        tbody.appendChild(fila);
                    });

                    // Fila de totales mensuales
                    const filaTotales = document.createElement('tr');
                    filaTotales.style.fontWeight = 'bold';
                    filaTotales.style.backgroundColor = '#ecf0f1';

                    const celdasTotales = [
                        'Totales del Mes',
                        '',
                        '',
                        '',
                        '',
                        '',
                        '',
                        '',
                        '',
                        totales.totalViajeros,
                        totales.ventaBilletes.toFixed(2),
                        '',
                        sumarTiempos(totales.tiempoTotalHoja),
                        sumarTiempos(totales.tiempoOperativo),
                        sumarTiempos(totales.excesoJornada),
                        totales.liquidacionTotal.toFixed(2)
                    ];

                    celdasTotales.forEach((valor, index) => {
                        const td = document.createElement('td');
                        td.textContent = valor;
                        filaTotales.appendChild(td);
                    });

                    tbody.appendChild(filaTotales);
                    tabla.appendChild(tbody);

                    // Título de la tabla
                    const tituloTabla = document.createElement('h2');
                    tituloTabla.textContent = `Año ${año} - Mes ${mes}`;
                    contenedor.appendChild(tituloTabla);

                    // Botones de exportación
                    const botonesExportar = document.createElement('div');
                    botonesExportar.classList.add('botones-accion');

                    const botonCSV = document.createElement('button');
                    botonCSV.textContent = 'Descargar CSV del Mes';
                    botonCSV.classList.add('btn-primary');
                    botonCSV.addEventListener('click', () => exportarCSV(registrosMes, año, mes));
                    botonesExportar.appendChild(botonCSV);

                    contenedor.appendChild(botonesExportar);

                    contenedor.appendChild(tabla);
                });

                // Totales anuales
                const registrosAño = Object.values(agrupados[año]).flat();
                let totalesAnuales = {
                    tiempoTotalHoja: [],
                    tiempoOperativo: [],
                    excesoJornada: [],
                    totalViajeros: 0,
                    ventaBilletes: 0,
                    liquidacionTotal: 0
                };

                registrosAño.forEach(registro => {
                    totalesAnuales.tiempoTotalHoja.push(registro.tiempoTotalHoja);
                    totalesAnuales.tiempoOperativo.push(registro.tiempoOperativo);
                    totalesAnuales.excesoJornada.push(registro.excesoJornada);
                    totalesAnuales.totalViajeros += parseInt(registro.totalViajeros);
                    totalesAnuales.ventaBilletes += parseFloat(registro.ventaBilletes);
                    totalesAnuales.liquidacionTotal += parseFloat(registro.liquidacionTotal);
                });

                // Crear resumen anual
                const resumenAnual = document.createElement('div');
                resumenAnual.classList.add('resumen-anual');
                resumenAnual.innerHTML = `
                    <h2>Resumen Anual ${año}</h2>
                    <p><strong>Total Viajeros:</strong> ${totalesAnuales.totalViajeros}</p>
                    <p><strong>Venta Billetes:</strong> ${totalesAnuales.ventaBilletes.toFixed(2)}</p>
                    <p><strong>Tiempo Total Hoja:</strong> ${sumarTiempos(totalesAnuales.tiempoTotalHoja)}</p>
                    <p><strong>Tiempo Operativo:</strong> ${sumarTiempos(totalesAnuales.tiempoOperativo)}</p>
                    <p><strong>Exceso Jornada:</strong> ${sumarTiempos(totalesAnuales.excesoJornada)}</p>
                    <p><strong>Liquidación Total (€):</strong> ${totalesAnuales.liquidacionTotal.toFixed(2)}</p>
                `;

                // Botón de exportación anual
                const botonCSVAnual = document.createElement('button');
                botonCSVAnual.textContent = 'Descargar CSV Anual';
                botonCSVAnual.classList.add('btn-primary');
                botonCSVAnual.addEventListener('click', () => exportarCSVAnual(registrosAño, año));
                resumenAnual.appendChild(botonCSVAnual);

                contenedor.appendChild(resumenAnual);
            });
        }

        // Función para rellenar el formulario al hacer clic en una fila
        function rellenarFormulario(registro) {
            document.getElementById('fecha').value = registro.fecha;
            document.getElementById('numeroConductor').value = registro.numeroConductor;
            document.getElementById('linea').value = registro.linea;
            document.getElementById('numeroTurno').value = registro.numeroTurno;
            document.getElementById('horaInicioHoja').value = registro.horaInicioHoja;
            document.getElementById('horaFinHoja').value = registro.horaFinHoja;
            document.getElementById('login').value = registro.login;
            document.getElementById('logout').value = registro.logout;
            document.getElementById('numeroAutobus').value = registro.numeroAutobus;
            document.getElementById('totalViajeros').value = registro.totalViajeros;
            document.getElementById('ventaBilletes').value = registro.ventaBilletes;
            document.getElementById('observaciones').value = registro.observaciones;
        }

        // Función para exportar CSV mensual
        function exportarCSV(registrosMes, año, mes) {
            let csv = '';
            const encabezados = [
                'Fecha',
                'Nº Conductor',
                'Línea',
                'Nº Turno',
                'Inicio Hoja',
                'Fin Hoja',
                'Login',
                'Logout',
                'Nº Autobús',
                'Total Viajeros',
                'Venta Billetes',
                'Observaciones',
                'Tiempo Total Hoja',
                'Tiempo Operativo',
                'Exceso Jornada',
                'Liquidación Total (€)'
            ];
            csv += encabezados.join(';') + '\n';

            registrosMes.forEach(registro => {
                const valores = [
                    registro.fecha,
                    registro.numeroConductor,
                    registro.linea,
                    registro.numeroTurno,
                    registro.horaInicioHoja,
                    registro.horaFinHoja,
                    registro.login,
                    registro.logout,
                    registro.numeroAutobus,
                    registro.totalViajeros,
                    registro.ventaBilletes,
                    registro.observaciones,
                    registro.tiempoTotalHoja,
                    registro.tiempoOperativo,
                    registro.excesoJornada,
                    registro.liquidacionTotal
                ];
                csv += valores.join(';') + '\n';
            });

            // Añadir totales mensuales
            let totales = {
                tiempoTotalHoja: [],
                tiempoOperativo: [],
                excesoJornada: [],
                totalViajeros: 0,
                ventaBilletes: 0,
                liquidacionTotal: 0
            };

            registrosMes.forEach(registro => {
                totales.tiempoTotalHoja.push(registro.tiempoTotalHoja);
                totales.tiempoOperativo.push(registro.tiempoOperativo);
                totales.excesoJornada.push(registro.excesoJornada);
                totales.totalViajeros += parseInt(registro.totalViajeros);
                totales.ventaBilletes += parseFloat(registro.ventaBilletes);
                totales.liquidacionTotal += parseFloat(registro.liquidacionTotal);
            });

            const filaTotales = [
                'Totales del Mes',
                '',
                '',
                '',
                '',
                '',
                '',
                '',
                '',
                totales.totalViajeros,
                totales.ventaBilletes.toFixed(2),
                '',
                sumarTiempos(totales.tiempoTotalHoja),
                sumarTiempos(totales.tiempoOperativo),
                sumarTiempos(totales.excesoJornada),
                totales.liquidacionTotal.toFixed(2)
            ];

            csv += filaTotales.join(';') + '\n';

            // Descargar archivo CSV
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const enlace = document.createElement('a');
            enlace.href = URL.createObjectURL(blob);
            enlace.download = `Registros_${año}_${mes}.csv`;
            enlace.style.display = 'none';
            document.body.appendChild(enlace);
            enlace.click();
            document.body.removeChild(enlace);
        }

        // Función para exportar CSV anual
        function exportarCSVAnual(registrosAño, año) {
            let csv = '';
            const encabezados = [
                'Fecha',
                'Nº Conductor',
                'Línea',
                'Nº Turno',
                'Inicio Hoja',
                'Fin Hoja',
                'Login',
                'Logout',
                'Nº Autobús',
                'Total Viajeros',
                'Venta Billetes',
                'Observaciones',
                'Tiempo Total Hoja',
                'Tiempo Operativo',
                'Exceso Jornada',
                'Liquidación Total (€)'
            ];
            csv += encabezados.join(';') + '\n';

            registrosAño.forEach(registro => {
                const valores = [
                    registro.fecha,
                    registro.numeroConductor,
                    registro.linea,
                    registro.numeroTurno,
                    registro.horaInicioHoja,
                    registro.horaFinHoja,
                    registro.login,
                    registro.logout,
                    registro.numeroAutobus,
                    registro.totalViajeros,
                    registro.ventaBilletes,
                    registro.observaciones,
                    registro.tiempoTotalHoja,
                    registro.tiempoOperativo,
                    registro.excesoJornada,
                    registro.liquidacionTotal
                ];
                csv += valores.join(';') + '\n';
            });

            // Añadir totales anuales
            let totalesAnuales = {
                tiempoTotalHoja: [],
                tiempoOperativo: [],
                excesoJornada: [],
                totalViajeros: 0,
                ventaBilletes: 0,
                liquidacionTotal: 0
            };

            registrosAño.forEach(registro => {
                totalesAnuales.tiempoTotalHoja.push(registro.tiempoTotalHoja);
                totalesAnuales.tiempoOperativo.push(registro.tiempoOperativo);
                totalesAnuales.excesoJornada.push(registro.excesoJornada);
                totalesAnuales.totalViajeros += parseInt(registro.totalViajeros);
                totalesAnuales.ventaBilletes += parseFloat(registro.ventaBilletes);
                totalesAnuales.liquidacionTotal += parseFloat(registro.liquidacionTotal);
            });

            const filaTotales = [
                'Totales del Año',
                '',
                '',
                '',
                '',
                '',
                '',
                '',
                '',
                totalesAnuales.totalViajeros,
                totalesAnuales.ventaBilletes.toFixed(2),
                '',
                sumarTiempos(totalesAnuales.tiempoTotalHoja),
                sumarTiempos(totalesAnuales.tiempoOperativo),
                sumarTiempos(totalesAnuales.excesoJornada),
                totalesAnuales.liquidacionTotal.toFixed(2)
            ];

            csv += filaTotales.join(';') + '\n';

            // Descargar archivo CSV
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const enlace = document.createElement('a');
            enlace.href = URL.createObjectURL(blob);
            enlace.download = `Registros_${año}.csv`;
            enlace.style.display = 'none';
            document.body.appendChild(enlace);
            enlace.click();
            document.body.removeChild(enlace);
        }

        // Función para exportar datos a JSON
        function exportarDatos() {
            const dataStr = JSON.stringify(registros, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const enlace = document.createElement('a');
            enlace.href = URL.createObjectURL(blob);
            enlace.download = 'registros.json';
            enlace.style.display = 'none';
            document.body.appendChild(enlace);
            enlace.click();
            document.body.removeChild(enlace);
        }

        // Función para importar datos desde JSON
        function importarDatos(event) {
            const archivo = event.target.files[0];
            if (!archivo) return;

            const lector = new FileReader();
            lector.onload = function(e) {
                try {
                    const datosImportados = JSON.parse(e.target.result);
                    if (Array.isArray(datosImportados)) {
                        if (confirm('Esto reemplazará todos los registros actuales. ¿Deseas continuar?')) {
                            registros = datosImportados;
                            localStorage.setItem('registros', JSON.stringify(registros));
                            actualizarTablas();
                            alert('Datos importados correctamente.');
                        }
                    } else {
                        alert('El archivo importado no tiene el formato correcto.');
                    }
                } catch (error) {
                    alert('Error al importar los datos: ' + error.message);
                }
            };
            lector.readAsText(archivo);
        }

        // Función para eliminar todos los registros
        function eliminarRegistros() {
            if (confirm('Esto eliminará todos los registros almacenados. ¿Estás seguro?')) {
                registros = [];
                localStorage.removeItem('registros');
                actualizarTablas();
                alert('Todos los registros han sido eliminados.');
            }
        }
    </script>
</body>
</html>
